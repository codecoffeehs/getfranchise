name: Deploy Get Franchise Frontend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            set -Eeuo pipefail

            echo ""
            echo "=============================="
            echo " ğŸš€ Starting Frontend Deployment"
            echo "=============================="
            echo ""

            APP_DIR="/var/www/app/getfranchise"
            CONTAINER_NAME="getfranchise"
            IMAGE_NAME="getfranchise"
            PORT="6001"

            echo "ğŸ“‚ Navigating to app directory..."
            cd $APP_DIR

            echo ""
            echo "â³ Pulling latest changes from Git..."
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Code updated."

            echo ""
            echo "ğŸ”§ Creating production environment file..."
            cat > .env.production << EOF
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_URL }}
            NODE_ENV=production
            EOF
            echo "âœ… Environment file updated."

            echo ""
            echo "ğŸ³ Building fresh Docker image..."
            docker build --no-cache -t $IMAGE_NAME .
            echo "âœ… Docker image built successfully."

            echo ""
            echo "ğŸ§¹ Removing old container if exists..."
            docker rm -f $CONTAINER_NAME 2>/dev/null || echo "â„¹ï¸ No existing container found."

            echo ""
            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p $PORT:6001 \
              -e NODE_ENV=production \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              $IMAGE_NAME

            echo "âœ… New container started successfully."

            echo ""
            echo "ğŸ§¼ Cleaning unused Docker images..."
            docker image prune -af || true

            echo ""
            echo "ğŸ“Š Container status:"
            docker ps --filter "name=$CONTAINER_NAME" \
              --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

            echo ""
            echo "ğŸ“¥ Last 20 logs:"
            docker logs --tail 20 $CONTAINER_NAME || true

            echo ""
            echo "ğŸ’½ Disk usage:"
            df -h | grep -E '^Filesystem|/var|/dev/'

            echo ""
            echo "=============================="
            echo " ğŸ‰ Frontend Deployment Completed Successfully!"
            echo "=============================="
