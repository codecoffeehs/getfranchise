name: Deploy Grahak 24 Frontend

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v0.1.3
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script_stop: true
                  script: |
                      set -Eeuo pipefail

                      echo ""
                      echo "=============================="
                      echo " ðŸš€ Starting Frontend Deployment"
                      echo "=============================="
                      echo ""

                      cd /var/www/app/getfranchise

                      echo "â³ Pulling latest changes..."
                      git pull
                      echo "âœ… Code updated."

                      echo ""
                      echo "ðŸ”§ Updating .env.production..."
                      cat > .env.production << EOF
                      NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_URL }}
                      EOF
                      echo "âœ… Environment file updated."

                      echo ""
                      echo "ðŸ³ Rebuilding Docker image (no cache)..."
                      docker build --no-cache -t getfranchise .
                      echo "âœ… Docker image rebuilt."

                      echo ""
                      echo "ðŸ§¹ Cleaning up old containers..."
                      docker stop getfranchise || true
                      docker rm getfranchise || true

                      echo ""
                      echo "ðŸš€ Starting new container..."
                      docker run -d \
                        --name getfranchise \
                        -p 6001:3000 \
                        -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                        getfranchise

                      echo "âœ… Container started."

                      echo ""
                      echo "ðŸ§¼ Removing dangling images..."
                      docker image prune -f || true

                      echo ""
                      echo "ðŸ“Š Checking container status..."
                      docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

                      echo ""
                      echo "ðŸ“¥ Showing last 20 logs of 'getfranchise'..."
                      docker logs --tail 20 getfranchise || true

                      echo ""
                      echo "ðŸ’½ Disk usage after deployment:"
                      df -h | grep -E '^Filesystem|/var|/dev/'

                      echo ""
                      echo "=============================="
                      echo " ðŸŽ‰ Deployment Completed!"
                      echo "=============================="
